import { beforeEach, describe, expect, it, vi } from "vitest";
import determineBackendUrl from "../util/determineBackendUrl";

describe("determineBackendUrl", () => {
  beforeEach(() => {
    const g = globalThis as any;
    g.window = g.window || {};
    delete g.window.__RUNTIME_ENV__;
    vi.unstubAllEnvs();
  });

  it("returns runtime BACKEND_URL when provided", () => {
    const g = globalThis as any;
    g.window.__RUNTIME_ENV__ = { BACKEND_URL: "http://localhost:8080" };

    const result = determineBackendUrl();

    expect(result).toBe("http://localhost:8080/");
  });

  it("falls back to VITE_BACKEND_URL when runtime value is missing", () => {
    vi.stubEnv("VITE_BACKEND_URL", "http://production-api");

    const result = determineBackendUrl();

    expect(result).toBe("http://production-api/");
  });

  it("falls back to BASE_URL + api/assistant when no runtime/env override", () => {
    const result = determineBackendUrl();

    expect(result.endsWith("api/assistant/")).toBe(true);
  });
});
