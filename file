import { describe, it, expect, vi, beforeEach } from "vitest";
import apiConnect from "../util/apiConnect";
import determineBackendUrl from "../util/determineBackendUrl";

vi.mock("../util/determineBackendUrl", () => ({
  default: vi.fn(),
}));

describe("apiConnect", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("sends the correct payload and returns data correctly", async () => {
    const mockResponse = {
      message: ["hello"],
      renderHtml: false,
      reply: { text: "ok" },
      responseRequired: [],
      userInputRequired: false,
    };

    (determineBackendUrl as unknown as ReturnType<typeof vi.fn>).mockReturnValue("http://localhost:8080/");
    global.fetch = vi.fn().mockResolvedValue({
      json: vi.fn().mockResolvedValue(mockResponse),
    } as any);

    const result = await apiConnect("Hello World", "mock-session");

    expect(determineBackendUrl).toHaveBeenCalled();
    expect(fetch).toHaveBeenCalledWith("http://localhost:8080/chatbot", {
      method: "POST",
      headers: expect.any(Headers),
      body: JSON.stringify({
        type: "chat",
        msg: "Hello World",
        sessionId: "mock-session",
      }),
    });
    expect(result).toEqual(mockResponse);
  });
});
