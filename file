import { describe, it, expect, vi, beforeEach } from "vitest";
import apiConnectIndex from "../util/apiConnectIndex";
import determineBackendUrl from "../util/determineBackendUrl";

vi.mock("../util/determineBackendUrl", () => ({
  default: vi.fn(),
}));

describe("apiConnectIndex", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("successfully fetches and returns correctly", async () => {
    const mockReply = "indexed";

    (determineBackendUrl as unknown as ReturnType<typeof vi.fn>).mockReturnValue("http://localhost:8080/");
    global.fetch = vi.fn().mockResolvedValue({
      json: vi.fn().mockResolvedValue({ reply: mockReply }),
    } as any);

    const result = await apiConnectIndex("test", "mock-session");

    expect(fetch).toHaveBeenCalledWith("http://localhost:8080/index", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        type: "index",
        msg: "test",
        sessionId: "mock-session",
      }),
    });
    expect(result).toBe(mockReply);
  });
});
